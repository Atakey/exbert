!function(t){function e(e){for(var i,o,r=e[0],h=e[1],l=e[2],c=0,u=[];c<r.length;c++)o=r[c],Object.prototype.hasOwnProperty.call(n,o)&&n[o]&&u.push(n[o][0]),n[o]=0;for(i in h)Object.prototype.hasOwnProperty.call(h,i)&&(t[i]=h[i]);for(d&&d(e);u.length;)u.shift()();return a.push.apply(a,l||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],i=!0,r=1;r<s.length;r++){var h=s[r];0!==n[h]&&(i=!1)}i&&(a.splice(e--,1),t=o(o.s=s[0]))}return t}var i={},n={0:0},a=[];function o(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=t,o.c=i,o.d=function(t,e,s){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(s,i,function(e){return t[e]}.bind(null,i));return s},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="";var r=window.webpackJsonp=window.webpackJsonp||[],h=r.push.bind(r);r.push=e,r=r.slice();for(var l=0;l<r.length;l++)e(r[l]);var d=h;a.push([82,1]),s()}({73:function(t,e){},74:function(t,e){},75:function(t,e){},76:function(t,e){},77:function(t,e){},78:function(t,e){},79:function(t,e,s){t.exports=s.p+"exBERT.html"},80:function(t,e,s){t.exports=s.p+"index.html"},81:function(t,e,s){},82:function(t,e,s){"use strict";s.r(e);var i,n=s(2),a=s(5),o=s(96),r=s(101),h=s(88);function l(t,e){return t<e?-1:t>e?1:0}function d(t,e){let s=[],i=a.findIndex(t,e,0);for(;-1!=i;)s.push(i),i=a.findIndex(t,e,i+1);return s}!function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED"}(i||(i={})),n.m.prototype.clear=function(){return this.selectAll("*").remove(),this},n.m.prototype.toggleClass=function(t){return this.classed(t,!this.classed(t)),this},n.m.prototype.show=function(){return this.style("display","initial"),this},n.m.prototype.hide=function(){return this.style("display","none"),this},n.m.prototype.toggle=function(){var t="none"==this.style("display");return this.style("display",t?"inherit":"none")},n.m.prototype.after=function(t){var e=[];return this.each((function(){var s=document.createElement(t);this.parentNode.insertBefore(s,this.nextSibling),e.push(s)})),n.l(e)},n.m.prototype.before=function(t){var e=[];return this.each((function(){var s=document.createElement(t);this.parentNode.insertBefore(s,this),e.push(s)})),n.l(e)};const c=[{text:"[SEP]",embeddings:[],contexts:[],bpe_token:"",bpe_pos:"",bpe_dep:"",bpe_is_ent:null}];class u{constructor(t=c,e=[]){this.sideMap={left:"a",right:"b"},this.tokenData=t,this.maskInds=e}mask(t){-1==a.indexOf(this.maskInds,t)?function(t,e,s=!1){s&&t.sort(l),function(t,e,s){t.splice(s,0,e)}(t,e,a.sortedIndex(t,e))}(this.maskInds,t):(console.log(`${t} already in maskInds!`),console.log(this.maskInds))}toggle(t){-1==a.indexOf(this.maskInds,t)?(console.log(`Masking ${t}`),this.mask(t)):(console.log(`Unmasking ${t}`),this.unmask(t))}unmask(t){a.pull(this.maskInds,t)}resetMask(){this.maskInds=[]}length(){return this.tokenData.length}concat(t){const e=a.concat(this.tokenData,t.tokenData),s=a.concat(this.maskInds,t.maskInds.map(t=>t+this.length()));return new u(e,s)}}class p{constructor(t){this.updateFromResponse(t)}updateFromResponse(t){const e=t.aa.left;this.updateFromComponents(e,[])}updateFromComponents(t,e){this.a=new u(t,e)}updateEmbeddingsFromMasking(t){const e=t.aa.left;this.a.tokenData.forEach((t,s)=>{t.embeddings=e.embeddings[s],t.contexts=e.contexts[s]})}mask(t,e){this[t].mask(e);this.a.length()}}var f=s(109),g=s(85);const m={};var b=s(39);function k(t,e){if(e){let s=t+"?";return Object.keys(e).forEach(t=>{s+=t,s+="=",s+=e[t],s+="&"}),s.replace(/&$/g,"")}return t}const v=t=>({method:"POST",body:JSON.stringify(t),headers:{"Content-type":"application/json; charset=UTF-8"}});class x{static basicURL(){const t=window.location.pathname.split("/").slice(0,-2).join("/");return window.location.origin+(t.length?t:"")}static get parameters(){const t=window.location.search.substring(1).split("&");console.log(t,"--- vars");const e={},s=t=>(t=>/^[0-9]+$/.test(t))(t)?Number.parseInt(t,10):(t=>/^[0-9]+\.[0-9]*$/.test(t))(t)?Number.parseFloat(t):t;return t.forEach(t=>{if(t.length>0){const i=t.split("="),n=decodeURIComponent(i[0]);let a=decodeURIComponent(i[1]);const o=a.startsWith("..");o&&(a=a.slice(2)),a.length<1?e[n]=o?[]:"":e[n]=o?a.split(",").map(t=>s(t)):s(a)}}),e}static urlString(t){const e=[];Object.keys(t).forEach(s=>{const i=t[s];if(void 0!==i){let t=i;Array.isArray(i)&&(t=".."+i.join(",")),e.push(encodeURI(s+"="+t))}});const s=window.location.pathname;let i=s.substring(s.lastIndexOf("/")+1);return e.length>0&&(i+="?"+e.join("&")),i}static updateURLParam(t,e,s=!0){const i=x.parameters;i[t]=e,x.updateUrl(i,s)}static updateUrl(t,e=!0){e?window.history.pushState(t,"",x.urlString(t)):window.history.replaceState(t,"",x.urlString(t))}}const y=new u,_=x.basicURL();function C(t){const e=b.sha1(t);if(console.log("CHECKING DEMOAPI: "+e),m.hasOwnProperty(e)){const t="./demo/"+m[e];return console.log("SENDING STATIC: ",t),n.c(t)}return!1}class M{constructor(t=null){this.baseURL=t,null==this.baseURL&&(this.baseURL=_+"/api")}getMetaAttentions(t,e,s="",i=null){const a={sentenceA:t,sentenceB:s,layer:e},o=k(this.baseURL+"/attend+meta",a);if(console.log("--- GET "+o),null!=i){const t=b.sha1(a);n.c(o).then(e=>{i[t]=e})}return C(a)||n.c(o)}updateMaskedMetaAttentions(t,e,s=y,i=null){const a={tokensA:f.a(g.a("text"),t.tokenData),tokensB:f.a(g.a("text"),s.tokenData),maskA:t.maskInds.length?t.maskInds:[-1],maskB:s.maskInds.length?s.maskInds:[-1],layer:e},o=k(this.baseURL+"/update-meta-mask"),r=v(a);if(null!=i){const t=b.sha1(a);n.c(o,r).then(e=>{i[t]=e})}return console.log("--- POST "+o,r),C(a)||n.c(o,r)}getNearestWozEmbeddings(t,e,s,i=10,a=null){const o={embedding:t,layer:e,heads:s,k:i},r=k(this.baseURL+"/woz-k-nearest-embeddings",o);if(console.log("--- GET "+r),null!=a){const t=b.sha1(o);n.c(r).then(e=>{a[t]=e})}return C(o)||n.c(r)}getNearestWozContexts(t,e,s,i=10,a=null){const o={context:t,layer:e,heads:s,k:i},r=k(this.baseURL+"/woz-k-nearest-contexts",o);if(console.log("--- GET "+r),null!=a){const t=b.sha1(o);n.c(r).then(e=>{a[t]=e})}return C(o)||n.c(r)}}var w=s(86),S=s(64);const H=t=>!(t=>new Set(["false",0,"no",!1,null,""]).has(t))(t),O=t=>+t;class I{constructor(t=12){this._conf={},this.nHeads=t,this.attType="aa",this.fromURL(),this.toURL(!1)}fromURL(){const t=x.parameters;this._conf={sentence:t.sentence||"The girl ran to a local pub to escape the din of her city.",layer:t.layer||0,heads:this._initHeads(t.heads),threshold:t.threshold||.7,tokenInd:t.tokenInd||null,tokenSide:t.tokenSide||null,maskInds:t.maskInds||[9],metaMatch:t.metaMatch||"pos",metaMax:t.metaMax||"pos",displayInspector:t.displayInspector||null,offsetIdxs:this._initOffsetIdxs(t.offsetIdxs),hideClsSep:H(t.hideClsSep)||!0},this._token={side:this._conf.tokenSide,ind:this._conf.tokenInd}}toURL(t=!1){x.updateUrl(this._conf,t)}_initOffsetIdxs(t){if(null==t)return[-1,0,1];return f.a(O,t)}_initHeads(t){return null==t?this.selectAllHeads():this.headSet(new Set(t))._conf.heads,this.heads()}toggleSelectAllHeads(){0==this.heads().length?this.selectAllHeads():this.selectNoHeads()}selectAllHeads(){this.headSet(new Set(a.range(0,this.nHeads)))}selectNoHeads(){this.headSet(new Set([]))}toggleHead(t){let e;return this.headSet().has(t)?(this.headSet().delete(t),e=i.REMOVED):(this.headSet().add(t),e=i.ADDED),this.headSet(this.headSet()),e}toggleToken(t){const e=w.a(["ind","side"]),s=e(t),i=e(this.token());return S.a(i,s)?(console.log("REMOVING TOKEN"),this.rmToken()):this.token(t),this}token(t){return null==t?this._token:(this._token=t,this._conf.tokenInd=t.ind,this._conf.tokenSide=t.side,this.toURL(),this)}rmToken(){return this.token({ind:null,side:null}),this}sentence(t){return null==t?this._conf.sentence:(this._conf.sentence=t,this.toURL(!0),this)}threshold(t){return null==t?this._conf.threshold:(this._conf.threshold=t,this.toURL(),this)}heads(){return this._conf.heads}layer(t){return null==t?this._conf.layer:(this._conf.layer=t,this.toURL(),this)}headSet(t){return null==t?this._headSet:(this._headSet=t,this._conf.heads=(e=this._headSet,Array.from(e).sort(l)),this.toURL(),this);var e}metaMatch(t){return null==t?this._conf.metaMax:(this._conf.metaMax=t,this.toURL(),this)}metaMax(t){return null==t?this._conf.metaMatch:(this._conf.metaMatch=t,this.toURL(),this)}maskInds(t){return null==t?this._conf.maskInds:(this._conf.maskInds=t,this.toURL(),this)}displayInspector(t){return null==t?this._conf.displayInspector:(this._conf.displayInspector=t,this.toURL(),this)}offsetIdxs(t){return null==t?this._conf.offsetIdxs:(this._conf.offsetIdxs=f.a(O,t),this.toURL(),this)}hideClsSep(t){return null==t?this._conf.hideClsSep:(this._conf.hideClsSep=H(t),this.toURL(),this)}}let A=0;class E{static simpleUId({prefix:t=""}){return t+(A+=1)}}class D{}D.setSelVisible=t=>t.attr("visibility","visible"),D.setSelHidden=t=>t.attr("visibility","hidden"),D.setVisible=t=>D.setSelVisible(n.l(t)),D.setHidden=t=>D.setSelHidden(n.l(t));class T{constructor(t){this.element=t,this.eventListeners=[]}bind(t,e){for(const s of t.split(" ")){this.eventListeners.push({eventName:s,eventFunction:e});const t=t=>e(t.detail,t);this.element.addEventListener(s,t,!1)}}getListeners(){return this.eventListeners}trigger(t,e){this.element.dispatchEvent(new CustomEvent(t,{detail:e}))}}s(59);class R{static translate({x:t,y:e}){return"translate("+t+","+e+")"}static rotate(t){return`rotate(${t})`}static group(t,e,s={x:0,y:0}){return t.append("g").attrs({class:e,transform:R.translate(s)})}}class j{constructor(t,e){this.id=E.simpleUId({}),this.parent=t,this.eventHandler=e||new T(this.parent.node()),this._visibility={hidden:!1}}superInitHTML(t={}){Object.keys(t).forEach(e=>this.options[e]=t[e]),this.base=this.parent.append("div").classed(this.css_name,!0)}superInitSVG(t={},e=["bg","main","fg"]){Object.keys(t).forEach(e=>this.options[e]=t[e]),this.layers={};const s=this.parent;this.base=R.group(s,this.css_name+" ID"+this.id,this.options.pos),e&&e.forEach(t=>{this.layers[t]=R.group(this.base,t)})}update(t){this._data=t,this._visibility.hidden||(this.renderData=this._wrangle(t),this._render(this.renderData))}updateOptions({options:t,reRender:e=!1}){Object.keys(t).forEach(e=>this.options[e]=t[e]),e&&this._render(this.renderData)}redraw(){this._render(this.renderData)}setHideElement(t){this._visibility.hideElement=t}hideView(){if(!this._visibility.hidden){(this._visibility.hideElement||this.parent).transition().styles({opacity:0,"pointer-events":"none"}).style("display","none"),this._visibility.hidden=!0}}unhideView(){if(this._visibility.hidden){(this._visibility.hideElement||this.parent).transition().styles({opacity:1,"pointer-events":null,display:null}),this._visibility.hidden=!1}}destroy(){this.base.remove()}clear(){this.base.html("")}}j.events={noEvent:"VComponent_noEvent"};class L extends j{constructor(t,e,s={}){super(t,e),this.eInfo=t=>({side:this.side,ind:t}),this.eEmbedding=(t,e)=>({side:this.side,ind:t,embeddings:e}),this.options={boxheight:26},this.superInitHTML(s)}mask(t){this.parent.selectAll(`.${this.css_name}`).each((e,s,i)=>{n.k(i[s]).classed("masked-token",a.includes(t,s))})}getEmbedding(t){return this._data[t]}_init(){}_wrangle(t){return this._data=t,this.data=t,this.totalHeight=this.options.boxheight*t.length,t}_render(t){const e=this.options,s=this;this.base.selectAll(`.${this.css_name}`).data(t).join("div").attr("class",(t,e)=>`token ${this.css_name} token-${e}`).attr("id",(t,e)=>`${this.css_name}-${e}`).style("height",e.boxheight+"px").text(t=>t.text).on("mouseover",(function(t,e){n.k(this).style("background","lightblue"),s.eventHandler.trigger(L.events.tokenMouseOver,s.eInfo(e))})).on("mouseout",(function(t,e){n.k(this).style("background",0),s.eventHandler.trigger(L.events.tokenMouseOut,s.eInfo(e))})).on("click",(t,e,i)=>{n.k(i[e]);s.eventHandler.trigger(L.events.tokenClick,s.eEmbedding(e,t.embeddings))}).on("dblclick",(t,e,i)=>{const a=n.k(i[e]);a.classed("masked-token",!a.classed("masked-token")),s.eventHandler.trigger(L.events.tokenDblClick,s.eInfo(e))})}}L.events={tokenMouseOver:"TextToken_TokenMouseOver",tokenMouseOut:"TextToken_TokenMouseOut",tokenClick:"TextToken_TokenClick",tokenDblClick:"TextToken_TokenDblClick"};class z extends L{constructor(t,e,s={}){super(t,e),this.css_name="left-token",this.side="left"}}class N extends L{constructor(t,e,s={}){super(t,e),this.css_name="right-token",this.side="right"}}var $=s(29);function W(t,e,s="left"){if(0==e.length)return{rows:[[]],labels:[],max:0};let i="left"==s?2:1,n=$.b(t).gather(e,0).mean([i]).transpose();return{rows:n.arraySync(),labels:e,max:n.max().arraySync()}}class U extends j{constructor(t,e,s={}){super(t,e),this.css_name="",this.rowCssName="att-head",this.boxCssName="att-rect",this._current={},this.options={boxDim:26,yscale:1,xscale:.5,side:"left"},this.superInitSVG(s),this._init()}_init(){this.headRows=this.base.selectAll(`.${this.rowCssName}`),this.headCells=this.headRows.selectAll(`${this.boxCssName}`),this.opacityScale=n.h().range([0,1])}updateCurrent(){const t=this.options,e=this._current;return e.headHeight=t.boxDim*t.yscale,e.headWidth=t.boxDim*t.xscale,e.xPad=e.headWidth,e.yPad=(t.boxDim-e.headHeight)/2,e.boxWidth=this._data.rows[0].length*e.headWidth,e.totalWidth=2*e.xPad+e.boxWidth,e.totalHeight=t.boxDim*this._data.rows.length,this._current}updateData(){const t=this.options,e=this,s=s=>({ind:s,side:t.side,head:e._data.labels[s]}),i=this.updateCurrent();this.base.html(""),this.parent.attr("width",i.totalWidth).attr("height",i.totalHeight),this.headRows=this.base.selectAll(`.${e.rowCssName}`).data(e._data.rows).join("g").attrs({class:(t,s)=>`${e.rowCssName} ${e.rowCssName}-${s}`,transform:(e,s)=>R.translate({x:i.xPad,y:t.boxDim*s+i.yPad}),width:i.boxWidth,height:i.headHeight}).on("mouseover",(s,i)=>{e.eventHandler.trigger(U.events.rowMouseOver,{ind:i,side:t.side})}).on("mouseout",(s,i)=>{e.eventHandler.trigger(U.events.rowMouseOut,{ind:i,side:t.side})}),this.headCells=this.headRows.selectAll(`${this.boxCssName}`).data(t=>t).join("rect").attrs({x:(t,e)=>e*i.headWidth,y:0,class:this.boxCssName,head:(t,s)=>e._data.labels[s],width:i.headWidth,height:i.headHeight,opacity:t=>this.opacityScale(t),fill:"blue"}).on("mouseover",(t,i)=>{e.eventHandler.trigger(U.events.boxMouseOver,s(i))}).on("mouseout",(t,i)=>{e.eventHandler.trigger(U.events.boxMouseOut,s(i))}).on("click",(t,i)=>{e.eventHandler.trigger(U.events.boxClick,s(i))}).append("svg:title").text((t,s)=>"Head "+e._data.labels[s])}_wrangle(t){return this._data=t,this.opacityScale=this.opacityScale.domain([0,t.max]),t}_render(t){this.updateData()}}U.events={rowMouseOver:"AttentionHeadBox_RowMouseOver",rowMouseOut:"AttentionHeadBox_RowMouseOut",boxMouseOver:"AttentionHeadBox_BoxMouseOver",boxMouseOut:"AttentionHeadBox_BoxMouseOut",boxClick:"AttentionHeadBox_BoxClick"};s(4);class P{constructor(t){this.data=t,this.tensData=$.a(t)}min(t){return this.tensData.min(t).dataSync()}max(t){return this.tensData.max(t).dataSync()}extent(t){return n.o(this.min(t),this.max(t))}format(t=.7){return function(t,e=1){let s,i=[];return t.forEach((t,a)=>{s=e*n.n(t);let o=0;const r=function(t,e){e||(e=function(t,e){return t[0]>e[0]?-1:1});let s={arr:[],sortIndices:[]},i=[];for(let e=0;e<t.length;e++)i[e]=[t[e],e];i.sort((function(t,e){return t[0]>e[0]?-1:1}));for(var n=0;n<t.length;n++)s.sortIndices.push(i[n][1]),s.arr[n]=i[n][0];return s}(t);r.arr.forEach((t,e)=>{if(o<s){const s={i:a,j:r.sortIndices[e],v:t};i.push(s),o+=t}})}),i}(this.data,t)}}const F=t=>5*t^.33;class B extends j{constructor(t,e,s={}){super(t,e),this.css_name="",this._threshold=.7,this.normByGroup=!1,this.options={boxheight:26,height:500,width:200},this.updateData=()=>{if(null!=this.graph)return n.l(".atn-curve").remove(),this.paths=this.graph.data(this.plotData).join("path"),this.createConnections(),this.updateOpacity(),this},this.createScales=()=>{if(this.opacityScales=[],this.normByGroup){const t=this.edgeData.extent(1);this.opacityScales=[],t.forEach((t,e)=>{this.opacityScales.push(n.h().domain([0,t[1]]).range([0,.9]))})}else{const t=n.e(this.plotData.map(t=>t.v));for(let e=0;e<this._data.length;e++)this.opacityScales.push(n.h().domain([0,t]).range([0,1]))}},this.superInitSVG(s),this._init()}_init(){this.svg=this.parent,this.graph=this.svg.selectAll(".atn-curve"),this.linkGen=n.d().x(t=>t[0]).y(t=>t[1])}createConnections(){const t=this.options;this.paths&&this.paths.attrs({d:(e,s)=>{const i={source:[0,t.boxheight*(e.i+.5)],target:[t.width,t.boxheight*(e.j+.5)]};return this.linkGen(i)},class:"atn-curve"}).attr("src-idx",(t,e)=>t.i).attr("target-idx",(t,e)=>t.j)}updateHeight(){return null!=this.svg&&this.svg.attr("height",this.options.height),this}updateWidth(){return null!=this.svg&&this.svg.attr("width",this.options.width),this}updateOpacity(){return null!=this.paths&&(this.paths.attr("opacity",t=>{return this.opacityScales[t.i](t.v)}),this.paths.attr("stroke-width",t=>{const e=this.opacityScales[t.i](t.v);return F(e)})),this}data(t){return null==t?this._data:(this._data=t,this.edgeData=new P(t),this.plotData=this.edgeData.format(this._threshold),this.createScales(),this.updateData(),this)}height(t){return null==t?this.options.height:(this.options.height=t,this.updateHeight(),this)}width(t){return null==t?this.options.width:(this.options.width=t,this.updateWidth(),this)}threshold(t){return null==t?this._threshold:(this._threshold=t,this.plotData=this.edgeData.format(this._threshold),this.createScales(),this.updateData(),this)}_wrangle(t){return t}_render(t){return this.svg.html(""),this.updateHeight(),this.updateWidth(),this.updateData(),this}}B.events={};const G=t=>+t.parentNode.getAttribute("matchidx"),V=t=>+t.parentNode.getAttribute("rownum"),q=t=>`rgba(0, 0, 255, ${.6*t})`;class Q extends j{constructor(t,e,s={}){super(t,e),this.css_name="corpus-inspector",this.options={},this.scaler=n.j().range([0,.9]).exponent(2),this.superInitHTML(s),this._init()}createRows(){const t=this._data;this.inspectorRows=this.base.selectAll(".inspector-row").data(t).join("div").classed("inspector-row",!0).attrs({matchIdx:t=>t.index,rowNum:(t,e)=>e}).on("mouseover",(t,e)=>{this.eventHandler.trigger(Q.events.rowMouseOver,{})})}addTooltip(){this.inspectorCells=this.inspectorCells.classed("celltooltip",!0).append("span").classed("tooltiptext",!0).html((t,e,s)=>{const i=t.is_ent?"<br>Entity":"",n=`<br>Attention: ${s[e].parentNode.getAttribute("att").slice(0,7)}`;return`POS: ${t.pos.toLowerCase()}<br>DEP: ${t.dep.toLowerCase()}`+i+n})}createCells(){const t=this;this.inspectorCells=this.inspectorRows.selectAll(".inspector-cell").data(t=>t.tokens).join("div").classed("inspector-cell",!0).attr("index-offset",(t,e,s)=>{return e-G(s[e])}).attrs({pos:t=>t.pos.toLowerCase(),dep:t=>t.dep.toLowerCase(),is_ent:t=>t.is_ent}).text(t=>t.token).classed("matched-cell",t=>t.is_match),this.inspectorCells.each((e,s,i)=>{if(s==G(i[s])){const a=e.inward,o=+n.e(a),r=V(i[s]),h=t.scaler.domain([0,o]);n.l(`.inspector-row[rownum='${r}']`).selectAll(".inspector-cell").style("background",(t,e)=>q(h(a[e]))).attr("att",(t,e)=>a[e])}}),t.addTooltip()}updateData(){this.createRows(),this.createCells()}_init(){}_wrangle(t){return this._data=t,t}_render(t){this.updateData()}}Q.events={rowMouseOver:"CorpusInspector_rowMouseOver",rowMouseOut:"CorpusInspector_rowMouseOut",rowClick:"CorpusInspector_rowClick",rowDblClick:"CorpusInspector_rowDblClick",cellMouseOver:"CorpusInspector_cellMouseOver",cellMouseOut:"CorpusInspector_cellMouseOut",cellClick:"CorpusInspector_cellClick",cellDblClick:"CorpusInspector_cellDblClick"};const K=["[CLS]","[SEP]"];class Z{constructor(t,e=[[],[]],s=!0){this.nLayers=12,this.nHeads=12,this.init(t,e,s)}init(t,e=[[],[]],s){this.isZeroed=s,this._att=t,this._zeroedAttTensor=function(t,e,s){let i=t.clone(),n=i.bufferSync();return a.range(n.shape[0]).forEach(t=>{a.range(n.shape[1]).forEach(i=>{a.includes(e,i)&&a.range(n.shape[2]).forEach(e=>{n.set(0,t,i,e)}),a.range(n.shape[2]).forEach(e=>{a.includes(s,e)&&a.range(n.shape[1]).forEach(s=>{n.set(0,t,s,e)})})})}),i}($.b(t),e[0],e[1]),this._attTensor=$.b(t),this.badToks=e}updateFromMasking(t,e){const s=t.aa,i=d(s.left.text,t=>a.includes(K,t)),n=d(s.right.text,t=>a.includes(K,t));this.init(s.att,[i,n],e)}updateFromNormal(t,e){const s=t.aa,i=s.left,n=s.right,o=d(i.map(t=>t.text),t=>a.includes(K,t)),r=d(n.map(t=>t.text),t=>a.includes(K,t));this.init(s.att,[o,r],e)}get attTensor(){return this.isZeroed?this._zeroedAttTensor:this._attTensor}get att(){return this.attTensor.arraySync()}zeroed(t){return null==t?this.isZeroed:(this.isZeroed=t,this)}toggleZeroing(){this.zeroed(!this.zeroed())}_byHeads(t){return 0==t.length?$.c(this._byHead(0)):this.attTensor.gather(t,0).sum(0)}_byHead(t){return this.attTensor.gather([t],0).squeeze([0])}byHeads(t){return this._byHeads(t).arraySync()}byHead(t){return this._byHead(t).arraySync()}}var X=s(89),J=s(90),Y=s(91),tt=s(108),et=s(92),st=s(93),it=s(62),nt=s(65),at=s(104),ot=s(94),rt=s(87),ht=s(107),lt=s(106);const dt=["#3957ff","#d3fe14","#c9080a","#fec7f8","#0b7b3e","#0bf0e9","#c203c8","#fd9b39","#888593","#906407","#98ba7f","#fe6794","#10b0ff","#ac7bff","#fee7c0","#964c63","#1da49c","#0ad811","#bbd9fd","#fe6cfe","#297192","#d1a09c","#78579e","#81ffad","#739400","#ca6949","#d9bf01","#646a58","#d5097e","#bb73a9","#ccf6e9","#9cb4b6","#b6a7d4","#9e8c62","#6e83c8","#01af64","#a71afd","#cfe589","#d4ccd1","#fd4109","#bf8f0e","#2f786e","#4ed1a5","#d8bb7d","#a54509","#6a9276","#a4777a","#fc12c9","#606f15","#3cc4d9","#f31c4e","#73616f","#f097c6","#fc8772","#92a6fe","#875b44","#699ab3","#94bc19","#7d5bf0","#d24dfe","#c85b74","#68ff57","#b62347","#994b91","#646b8c","#977ab4","#d694fd","#c4d5b5","#fdc4bd","#1cae05","#7bd972","#e9700a","#d08f5d","#8bb9e1","#fde945","#a29d98","#1682fb","#9ad9e0","#d6cafe","#8d8328","#b091a7","#647579","#1f8d11","#e7eafd","#b9660b","#a4a644","#fec24c","#b1168c","#188cc1","#7ab297","#4468ae","#c949a6","#d48295","#eb6dc2","#d5b0cb","#ff9ffb","#fdb082","#af4d44","#a759c4","#a9e03a","#0d906b","#9ee3bd","#5b8846","#0d8995","#f25c58","#70ae4f","#847f74","#9094bb","#ffe2f1","#a67149","#936c8e","#d04907","#c3b8a6","#cef8c4","#7a9293","#fda2ab","#2ef6c5","#807242","#cb94cc","#b6bdd0","#b5c75d","#fde189","#b7ff80","#fa2d8e","#839a5f","#28c2b5","#e5e9e1","#bc79d8","#7ed8fe","#9f20c3","#4f7a5b","#f511fd","#09c959","#bcd0ce","#8685fd","#98fcff","#afbff9","#6d69b4","#5f99fd","#aaa87e","#b59dfb","#5d809d","#d9a742","#ac5c86","#9468d5","#a4a2b2","#b1376e","#d43f3d","#05a9d1","#c38375","#24b58e","#6eabaf","#66bf7f","#92cbbb","#ddb1ee","#1be895","#c7ecf9","#a6baa6","#8045cd","#5f70f1","#a9d796","#ce62cb","#0e954d","#a97d2f","#fcb8d3","#9bfee3","#4e8d84","#fc6d3f","#7b9fd4","#8c6165","#72805e","#d53762","#f00a1b","#de5c97","#8ea28b","#fccd95","#ba9c57","#b79a82","#7c5a82","#7d7ca4","#958ad6","#cd8126","#bdb0b7","#10e0f8","#dccc69","#d6de0f","#616d3d","#985a25","#30c7fd","#0aeb65","#e3cdb4","#bd1bee","#ad665d","#d77070","#8ea5b8","#5b5ad0","#76655e","#598100","#86757e","#5ea068"];class ct{constructor(){this.colorScale=this.createColorScales()}createColorScales(){const t=t=>{const e=rt.a(f.a(String,t),dt.slice(0,t.length));return t=>ht.a("black",t,e)};return{pos:t(ct.TotalMetaOptions.pos),dep:t(ct.TotalMetaOptions.dep),is_ent:t(ct.TotalMetaOptions.is_ent),ents:t(ct.TotalMetaOptions.ents),offset:n.i().range(["black"])}}}ct.EnglishMetaOptions={pos:["punct","sym","x","adj","verb","conj","num","et","adv","x","adp","noun","propn","part","pron","space","intj"],dep:["root","ROOT","acl","acomp","advcl","advmod","agent","amod","appos","attr","aux","auxpass","case","cc","ccomp","compound","conj","cop","csubj","csubjpass","dative","dep","det","dobj","expl","intj","mark","meta","neg","nn","nounmod","npmod","nsubj","nsubjpass","nummod","oprd","obj","obl","parataxis","pcomp","pobj","poss","preconj","predet","prep","prt","punct","quantmod","relcl","root","xcomp","npadvmod"],is_ent:[!0,!1],ents:["person","norp","fac","org","gpe","loc","product","event","work_of_art","law","language","date","time","percent","money","quantity","ordinal","cardinal"]},ct.UniversalMetaOptions={pos:["adj","adp","adv","aux","conj","cconj","det","intj","noun","num","part","pron","propn","punct","sconj","sym","verb","x","space"],dep:["acl","advcl","advmod","amod","appos","aux","case","cc","ccomp","clf","compound","conj","cop","csubj","dep","det","discourse","dislocated","expl","fixed","flat","goeswith","iobj","list","mark","nmod","nsubj","nummod","obj","obl","orphan","parataxis","punct","reparandum","root","vocative","xcomp"],is_ent:[!0,!1],ents:["person","norp","fac","org","gpe","loc","product","event","work_of_art","law","language","date","time","percent","money","quantity","ordinal","cardinal"]},ct.TotalMetaOptions={pos:lt.a(ct.EnglishMetaOptions.pos,ct.UniversalMetaOptions.pos),dep:ct.EnglishMetaOptions.dep,is_ent:ct.EnglishMetaOptions.is_ent,ents:ct.EnglishMetaOptions.ents};const ut=new ct;class pt extends j{constructor(t,e,s={}){super(t,e),this.css_name="corpus-mat-container",this.options={cellWidth:10,toPick:["pos"],idxs:[-1,0,1],divHover:{width:60,height:40}},this._current={},this.rowCssName="index-match-results",this.cellCssName="index-cell-result",this.idxs=[-1,0,1],this.superInitHTML(s),this._init()}get idxs(){return this.options.idxs}set idxs(t){this.options.idxs=t}_init(){this.corpusMats=this.base.selectAll(".corpus-mat"),this.rowGroups=this.corpusMats.selectAll(`.${this.rowCssName}`),this.divHover=this.base.append("div").classed("mat-hover-display",!0).classed("text-center",!0).style("width",String(this.options.divHover.width)+"px").style("height",String(this.options.divHover.height)+"px"),this.divHover.append("p")}pick(t){this.options.toPick=[t],this.redraw()}addRight(){const t=X.a(this.idxs)+1;this.idxs.push(t),this.addCorpusMat(t,"right")}addLeft(){const t=this.idxs[0]-1;this.idxs=(t=>J.a(0,Y.a(t)-1)(t))(this.idxs),this.addCorpusMat(t,"left")}killRight(){this.kill(Math.max(...this.idxs))}killLeft(){this.kill(Math.min(...this.idxs))}kill(t){0!=t&&(t!=Math.min(...this.idxs)&&t!=Math.max(...this.idxs)||(this.idxs=tt.a([t],this.idxs),this.base.selectAll(`.offset-${t}`).remove()))}_wrangle(t){return t}data(t){return null==t?this._data:(this._data=t,this._updateData(),this)}_updateData(){const t=this;this.options;this.base.selectAll(".corpus-mat").remove(),this.idxs.forEach((e,s)=>{t.addCorpusMat(e)})}addCorpusMat(t,e="right"){const s=this,i=this.options,n=i.cellWidth*i.toPick.length,a=et.a(f.a(g.a("height"),this._data));let o;if("right"==e)o=this.base.append("div");else{if("left"!=e)throw Error("toThe must have argument of 'left' or 'right'");o=this.base.insert("div",":first-child")}o=o.data([t]).attr("class",`corpus-mat offset-${t}`).append("svg").attrs({width:n,height:a}).on("mouseover",(function(t,e){s.eventHandler.trigger(pt.events.mouseOver,{idx:t,val:s.options.toPick[0]})})).on("mouseout",(t,e)=>{this.eventHandler.trigger(pt.events.mouseOut,{idx:t})}),this.addRowGroup(o)}addRowGroup(t){const e=this,s=this.options,i=f.a(g.a("height"),this._data),[n,a]=st.a((t,e)=>[it.a(t,e),it.a(t,e)],0,i),o=nt.a(at.a(1),ot.a(0))(a),r=t.selectAll(`.${e.rowCssName}`).data(t=>(function(t,e=0,s=["pos"]){const i={pos:null,dep:null,is_ent:null,token:null},n=w.a(s);return t.map(t=>{const s=t.index+e;if(s<0||s>=t.tokens.length)return h.a("height",t.height,i);const a=n(t.tokens[s]);return h.a("height",t.height,a)})})(e._data,t,s.toPick)).join("g").attr("class",(t,s)=>`${e.rowCssName} ${e.rowCssName}-${s}`).attr("height",t=>t.height).attr("transform",(t,e)=>{return R.translate({x:0,y:o[e]})});s.toPick.forEach(t=>{e.addRect(r,0,t)})}addRect(t,e,s){const i=this,a=this.options;t.append("rect").attrs({width:a.cellWidth,height:t=>t.height-3,transform:(t,s)=>R.translate({x:e,y:1.5})}).style("fill",t=>pt.colorScale[s](t[s]));t.on("mouseover",(function(){i.divHover.style("visibility","visible")})).on("mouseout",(function(){i.divHover.style("visibility","hidden")})).on("mousemove",(function(t){const e=n.f(i.base.node()),o=[3,3],r=e[0]+(()=>i.base.node().getBoundingClientRect().left)()-(a.divHover.width+o[0]),h=e[1]+(()=>i.base.node().getBoundingClientRect().top)()-(a.divHover.height+o[1]);i.divHover.style("left",String(r)+"px").style("top",String(h)+"px").selectAll("p").text(t[s])}))}_render(t){this._updateData()}}pt.events={mouseOver:"CorpusMatManager_MouseOver",mouseOut:"CorpusMatManager_MouseOut",click:"CorpusMatManager_Click",dblClick:"CorpusMatManager_DblClick"},pt.colorScale=ut.colorScale;var ft=s(95),gt=s(61);ft.a(nt.a(t=>{const e=+t;return isNaN(e)?t:e},g.a("label")));const mt=ft.a(g.a("count")),bt=nt.a(gt.a,mt,t=>Object.keys(t).map((e,s)=>({label:e,count:t[e]})));class kt extends j{constructor(t,e,s={}){super(t,e),this.css_name="",this._current={chart:{height:null,width:null}},this.axes={x:n.g(),y:n.h()},this.options={margin:{top:10,right:30,bottom:30,left:40},barWidth:25,width:185,height:200,val:"pos",xLabelRot:45,xLabelOffset:15,yLabelOffset:5},this.superInitSVG()}meta(t){return null==t?this.options.val:(this.options.val=t,this.update(this._data),this)}_init(){}createXAxis(){const t=this.options,e=t.width-t.margin.left-t.margin.right;this.axes.x.domain(f.a(g.a("label"),this.renderData)).rangeRound([0,e]).padding(.1),this._current.chart.width=e}createYAxis(){const t=this.options,e=t.height-t.margin.top-t.margin.bottom;this.axes.y.domain([0,+n.e(f.a(g.a("count"),this.renderData))]).rangeRound([e,0]),this._current.chart.height=e}createAxes(){this.createXAxis(),this.createYAxis()}_wrangle(t){const e=t[this.options.val];return bt(e)}width(t){return null==t?this.options.width:(this.options.width=t,this.updateWidth(),this.createXAxis(),this)}height(t){return null==t?this.options.height:(this.options.height=t,this.updateHeight(),this.createYAxis(),this)}updateWidth(){this.svg.attr("width",this.options.width)}updateHeight(){this.svg.attr("height",this.options.height)}figWidth(t){const e=this.options;return t.length*e.barWidth+e.margin.left+e.margin.right}_render(t){const e=this,s=this.options,i=this._current;this.parent.html(""),this.svg=this.parent,this.createAxes(),this.width(this.figWidth(t)),this.updateHeight();const a=e.svg.append("g").attr("transform",R.translate({x:s.margin.left,y:s.margin.top}));e.base=a;const o=a.append("g").attr("transform",R.translate({x:0,y:i.chart.height})).call(n.a(e.axes.x));"offset"!=s.val&&o.selectAll("text").attr("y",s.yLabelOffset).attr("x",s.xLabelOffset).attr("transform",R.rotate(s.xLabelRot)),a.append("g").call(n.b(e.axes.y)),a.selectAll(".bar").data(t).join("rect").attr("class","bar").attr("x",(function(t){return e.axes.x(t.label)})).attr("y",(function(t){return e.axes.y(t.count)})).attr("width",e.axes.x.bandwidth()).attr("height",(function(t){return i.chart.height-e.axes.y(t.count)})).style("fill",t=>ut.colorScale[s.val](t.label))}}kt.events={};var vt=s(97),xt=s(98),yt=s(99),_t=s(66),Ct=s(100);const Mt=o.a((t,e)=>rt.a(e,f.a(t,e)))(t=>0),wt=vt.a(xt.a(String),yt.a,_t.a);const St=t=>t.tokens[function(t){return[].map.call(t,(t,e)=>[t,e]).reduce((t,e)=>e[0]>t[0]?e:t)[1]}(t.matched_att.out.att)];class Ht{constructor(t){this.data=t}countPosInfo(){const t=this.data.map((t,e)=>+t.matched_att.out.offset_to_max),e={offset:Mt(t)};return t.forEach(t=>{Object.keys(e).forEach(s=>{e[s][t]+=1})}),e}countMaxAttKeys(t=0){const e={pos:Mt(ct.TotalMetaOptions.pos),dep:Mt(ct.TotalMetaOptions.dep),is_ent:Mt(ct.TotalMetaOptions.is_ent)};return this.data.forEach(t=>{const s=St(t);Object.keys(e).forEach(t=>{const i=wt(String(s[t]));e[t][i]+=1})}),Object.assign(e,this.countPosInfo())}countMatchedKeys(t=0){const e={pos:Mt(ct.TotalMetaOptions.pos),dep:Mt(ct.TotalMetaOptions.dep),is_ent:Mt(ct.TotalMetaOptions.is_ent)};return this.data.forEach(s=>{const i=s.tokens[s.index+t];Object.keys(e).forEach(t=>{const s=wt(String(i[t]));e[t][s]+=1})}),e}getMatchedHistogram(t=0){const e=this.countMatchedKeys(t);return f.a(Ct.a((t,e)=>0!=t),e)}getMaxAttHistogram(){const t=this.countMaxAttKeys();return f.a(Ct.a((t,e)=>0!=t),t)}}var Ot=s(102),It=s(63),At=s(103),Et=s(50),Dt=s(105);function Tt(t){const e=t=>null==t||"null"==t,s=null==t,i=e(t.side)||e(t.ind);return s||i}function Rt(t){if(!Tt(t)){const e="left"==t.side?"src-idx":"target-idx";D.setHidden(".atn-curve"),D.setVisible(`.atn-curve[${e}='${t.ind}']`)}}function jt(t){n.l(`.att-rect[head='${t}']`).classed("unselected",!0)}function Lt(t){n.l(`.att-rect[head='${t}']`).classed("unselected",!1)}function zt(t,e){const s=!!t||null;e.attr("disabled",s)}class Nt{constructor(){this.api=new M,this.uiConf=new I,this._mainInit()}_mainInit(){this.api.getMetaAttentions(this.uiConf.sentence(),this.uiConf.layer()).then(t=>{this.uiConf.nHeads=t[this.uiConf.attType].att.length,this._init(t);const e=()=>{this._toggleTokenSel();const t=this.uiConf.displayInspector();this._searchDisabler(),"context"==t?this._queryContext():"embeddings"==t&&this._queryEmbeddings()};this.uiConf.maskInds().length>0?(this.tokCapsule.a.maskInds=this.uiConf.maskInds(),this.api.updateMaskedMetaAttentions(this.tokCapsule.a,this.uiConf.layer()).then(t=>{this.attCapsule.updateFromMasking(t,this.uiConf.hideClsSep()),this.tokCapsule.updateEmbeddingsFromMasking(t),this.update(),e()})):(this.update(),e())})}_init(t){this.attCapsule=function(t,e){const s=t.aa,i=s.left,n=s.right,o=d(i.map(t=>t.text),t=>a.includes(K,t)),r=d(n.map(t=>t.text),t=>a.includes(K,t));return new Z(s.att,[o,r],e)}(t,this.uiConf.hideClsSep()),this.tokCapsule=new p(t),this.sels={body:n.k("body"),atnContainer:n.k("#atn-container"),atnDisplay:n.k("#atn-display"),atnHeads:{left:n.k("#left-att-heads"),right:n.k("#right-att-heads")},form:{sentenceA:n.k("#form-sentence-a"),button:n.k("#update-sentence")},tokens:{left:n.k("#left-tokens"),right:n.k("#right-tokens")},clsToggle:n.k("#cls-toggle").select(".switch"),layerCheckboxes:n.k("#layer-select"),headCheckboxes:n.k("#head-select"),contextQuery:n.k("#search-contexts"),embeddingQuery:n.k("#search-embeddings"),selectedHeads:n.k("#selected-heads"),headSelectAll:n.k("#select-all-heads"),headSelectNone:n.k("#select-no-heads"),testCheckbox:n.k("#simple-embed-query"),threshSlider:n.k("#my-range"),corpusInspector:n.k("#corpus-similar-sentences-div"),corpusMatManager:n.k("#corpus-mat-container"),histograms:{matchedWord:n.k("#matched-histogram-container"),maxAtt:n.k("#max-att-histogram-container")},buttons:{killLeft:n.k("#kill-left"),addLeft:n.k("#minus-left"),addRight:n.k("#plus-right"),killRight:n.k("#kill-right"),refresh:n.k("#mat-refresh")},metaSelector:{matchedWord:n.k("#matched-meta-select"),maxAtt:n.k("#max-att-meta-select")}},this.eventHandler=new T(this.sels.body.node()),this.vizs={leftHeads:new U(this.sels.atnHeads.left,this.eventHandler,{side:"left"}),rightHeads:new U(this.sels.atnHeads.right,this.eventHandler,{side:"right"}),tokens:{left:new z(this.sels.tokens.left,this.eventHandler),right:new N(this.sels.tokens.right,this.eventHandler)},attentionSvg:new B(this.sels.atnDisplay,this.eventHandler),corpusInspector:new Q(this.sels.corpusInspector,this.eventHandler),corpusMatManager:new pt(this.sels.corpusMatManager,this.eventHandler,{idxs:this.uiConf.offsetIdxs()}),histograms:{matchedWord:new kt(this.sels.histograms.matchedWord,this.eventHandler),maxAtt:new kt(this.sels.histograms.maxAtt,this.eventHandler)}},this._staticInits(),this._bindEventHandler()}_bindEventHandler(){this.eventHandler.bind(L.events.tokenDblClick,t=>{const e=function(t,e){return"all"==e?"all":"left"==t?e[0]:e[1]}(t.side,this.uiConf.attType);this.tokCapsule[e].toggle(t.ind),this.sels.body.style("cursor","progress"),this.api.updateMaskedMetaAttentions(this.tokCapsule.a,this.uiConf.layer()).then(t=>{this.attCapsule.updateFromMasking(t,this.uiConf.hideClsSep()),this.tokCapsule.updateEmbeddingsFromMasking(t),this.uiConf.maskInds(this.tokCapsule.a.maskInds),this.update(),this.sels.body.style("cursor","default")})}),this.eventHandler.bind(L.events.tokenMouseOver,t=>{!function(t,e){Tt(t)&&Rt(e)}(this.uiConf.token(),t)}),this.eventHandler.bind(L.events.tokenMouseOut,t=>{!function(t){Tt(t)&&D.setVisible(".atn-curve")}(this.uiConf.token())}),this.eventHandler.bind(L.events.tokenClick,t=>{this.uiConf.toggleToken(t),this._toggleTokenSel(),Rt(t)}),this.eventHandler.bind(U.events.rowMouseOver,t=>{}),this.eventHandler.bind(U.events.rowMouseOut,()=>{}),this.eventHandler.bind(U.events.boxMouseOver,t=>{const e=this.attCapsule.byHead(t.head);this.vizs.attentionSvg.data(e),this.vizs.attentionSvg.update(e),Rt(this.uiConf.token())}),this.eventHandler.bind(U.events.boxMouseOut,()=>{const t=this.attCapsule.byHeads(this.uiConf.heads());this.vizs.attentionSvg.data(t),this.vizs.attentionSvg.update(t),Rt(this.uiConf.token())}),this.eventHandler.bind(U.events.boxClick,t=>{const e=this.uiConf.toggleHead(t.head);e==i.ADDED?Lt(t.head):e==i.REMOVED&&jt(t.head),this._searchDisabler(),this._renderHeadSummary(),this.renderSvg()}),this.eventHandler.bind(pt.events.mouseOver,t=>{const e=`.inspector-cell[index-offset='${t.idx}']`;n.l(e).classed("hovered-col",!0)}),this.eventHandler.bind(pt.events.mouseOut,t=>{const e=`.inspector-cell[index-offset='${t.idx}']`;n.l(e).classed("hovered-col",!1)})}_toggleTokenSel(){const t=this.uiConf.token(),e=n.k(".selected-token");if(Tt(t)){const t=n.l(".selected-token");t.empty()||t.classed("selected-token",!1)}else{const e=t=>`#${t.side}-token-${t.ind}`,s=n.k(e(t));s.empty()||s.classed("selected-token",!0)}e.empty()||e.classed("selected-token",!1),this._searchDisabler()}_staticInits(){this._initSentenceForm(),this._initQueryForm(),this._initCheckboxes(),this._initAdder(),this._renderHeadSummary(),this._initMetaSelectors(),this._initToggle(),this.renderAttHead()}_initAdder(){const t=()=>{this.uiConf.offsetIdxs(this.vizs.corpusMatManager.idxs)},e=()=>{const e=this._wrapResults(this.vizs.corpusMatManager.data());this.vizs.corpusMatManager.data(e.data),t()};this.sels.buttons.addRight.on("click",()=>{this.vizs.corpusMatManager.addRight(),t()}),this.sels.buttons.addLeft.on("click",()=>{this.vizs.corpusMatManager.addLeft(),t()}),this.sels.buttons.killRight.on("click",()=>{this.vizs.corpusMatManager.killRight(),t()}),this.sels.buttons.killLeft.on("click",()=>{this.vizs.corpusMatManager.killLeft(),t()}),this.sels.buttons.refresh.on("click",()=>{e()});window.onresize=()=>{""!=this.sels.corpusInspector.text()&&e()}}_initMetaSelectors(){this._initMatchedWordSelector(this.sels.metaSelector.matchedWord),this._initMaxAttSelector(this.sels.metaSelector.maxAtt)}_initMaxAttSelector(t){const e=this;var s;s=this.uiConf.metaMax(),t.selectAll("label").classed("active",!1),t.selectAll(`label[value=${s}]`).classed("active",!0),t.selectAll("label").on("click",(function(){const s=n.k(this).attr("value");t.selectAll(".active").classed("active",!1),n.k(this).classed("active",!0),e.uiConf.metaMax(s),e.vizs.histograms.maxAtt.meta(s)}))}_initMatchedWordSelector(t){const e=this;var s;s=this.uiConf.metaMatch(),t.selectAll("label").classed("active",!1),t.selectAll(`label[value=${s}]`).classed("active",!0),t.selectAll("label").on("click",(function(){const s=n.k(this).attr("value");t.selectAll(".active").classed("active",!1),n.k(this).classed("active",!0),e.uiConf.metaMatch(s),e._updateCorpusInspectorFromMeta(s)}))}_disableSearching(t){zt(t,this.sels.contextQuery),zt(t,this.sels.embeddingQuery)}_updateCorpusInspectorFromMeta(t){this.vizs.corpusMatManager.pick(t),this.vizs.histograms.matchedWord.meta(t)}_initSentenceForm(){const t=this;this.sels.form.sentenceA.attr("placeholder","Enter new sentence to analyze"),this.sels.form.sentenceA.attr("value",this.uiConf.sentence());const e=()=>{const e=this.sels.form.sentenceA.property("value").replace(/\#/g,"");e.length&&(this.sels.body.style("cursor","progress"),this.api.getMetaAttentions(e,this.uiConf.layer()).then(s=>{this.uiConf.sentence(e),this.uiConf.rmToken(),this.attCapsule.updateFromNormal(s,this.uiConf.hideClsSep()),this.tokCapsule.updateFromResponse(s),this._toggleTokenSel(),this.update(),t.vizs.corpusMatManager.clear(),t.vizs.corpusInspector.clear(),t.vizs.histograms.matchedWord.clear(),t.vizs.histograms.maxAtt.clear(),this.sels.body.style("cursor","default")}))},s=o.a((t,e,s)=>{const i=s||window.event;i.keyCode===t&&(i.preventDefault(),e())})(13,e),i=this.sels.form.button,n=this.sels.form.sentenceA;i.on("click",e),n.on("keypress",s)}_getSearchEmbeds(){const t=this.uiConf.token();return this.vizs.tokens[t.side].getEmbedding(t.ind).embeddings}_getSearchContext(){const t=this.uiConf.token();return this.vizs.tokens[t.side].getEmbedding(t.ind).contexts}_searchEmbeddings(){const t=this;console.log("SEARCHING EMBEDDINGS");const e=this._getSearchEmbeds(),s=t.uiConf.layer(),i=t.uiConf.heads();this.sels.body.style("cursor","progress"),t.api.getNearestWozEmbeddings(e,s,i,50).then(e=>{t.vizs.corpusInspector.update(e);const s=t._wrapResults(e),i=s.getMatchedHistogram(),n=s.getMaxAttHistogram();t.vizs.corpusMatManager.update(s.data),t.vizs.histograms.matchedWord.update(i),t.vizs.histograms.maxAtt.update(n),t.uiConf.displayInspector("embeddings"),this._updateCorpusInspectorFromMeta(this.uiConf.metaMatch()),this.sels.body.style("cursor","default")})}_searchContext(){const t=this;console.log("SEARCHING CONTEXTS");const e=this._getSearchContext(),s=t.uiConf.layer(),i=t.uiConf.heads();this.sels.body.style("cursor","progress"),t.api.getNearestWozContexts(e,s,i,50).then(e=>{t.vizs.corpusInspector.update(e);const s=t._wrapResults(e),i=s.getMatchedHistogram(),n=s.getMaxAttHistogram();t.vizs.corpusMatManager.update(s.data),t.vizs.histograms.matchedWord.update(i),t.vizs.histograms.maxAtt.update(n),t.uiConf.displayInspector("context"),this._updateCorpusInspectorFromMeta(this.uiConf.metaMatch()),t.vizs.histograms.maxAtt.meta(t.uiConf.metaMax()),this.sels.body.style("cursor","default")})}_queryContext(){Tt(this.uiConf.token())?console.log("Was told to show inspector but was not given a selected token embedding"):this._searchContext()}_queryEmbeddings(){Tt(this.uiConf.token())?console.log("Was told to show inspector but was not given a selected token embedding"):this._searchEmbeddings()}_searchingDisabled(){return 0==this.uiConf.heads().length||Tt(this.uiConf.token())}_searchDisabler(){this._disableSearching(this._searchingDisabled())}_initQueryForm(){const t=this;this._searchDisabler(),this.sels.contextQuery.on("click",()=>{t._queryContext()}),this.sels.embeddingQuery.on("click",()=>{t._queryEmbeddings()})}_renderHeadSummary(){this.sels.selectedHeads.html(r.a(", ",this.uiConf.heads()))}_wrapResults(t){const e=n.l(".inspector-row").nodes().map(t=>t.getBoundingClientRect().height),s=t.map((t,s)=>h.a("height",e[s],t));return new Ht(s)}_initCheckboxes(){const t=this,e=this.sels.layerCheckboxes.selectAll(".layerCheckbox").data(a.range(0,this.attCapsule.nLayers)).join("label").attr("class","btn button layerCheckbox").classed("active",(t,e)=>0==e).text(t=>t).append("input").attr("type","radio").attr("class","checkbox-inline").attr("name","layerbox").attr("id",(t,e)=>"layerCheckbox"+e);Object(Ot.a)(e.nodes(),"change").pipe(Object(At.a)(t=>{const e=n.k(t.target).datum();console.log(e,"--- myData"),this.sels.layerCheckboxes.selectAll(".layerCheckbox").classed("active",t=>t===e)}),Object(Et.a)(t=>+n.k(t.target).datum()),Object(At.a)(e=>{console.log("New layer: ",e),t.uiConf.layer(e),t.sels.body.style("cursor","progress")}),Object(Dt.a)(e=>Object(It.a)(t.api.updateMaskedMetaAttentions(t.tokCapsule.a,e)))).subscribe({next:e=>{t.attCapsule.updateFromMasking(e,t.uiConf.hideClsSep()),t.tokCapsule.updateEmbeddingsFromMasking(e),t.uiConf.maskInds(t.tokCapsule.a.maskInds),t.update(),t.sels.body.style("cursor","default"),t._toggleTokenSel()}});const s=`#layerCheckbox${this.uiConf.layer()}`;n.k(s).attr("checked","checked");const i=t=>Math.round(100*t);n.k("#my-range-value").text(i(t.uiConf.threshold())),this.sels.threshSlider.on("input",a.throttle((function(){t.uiConf.threshold(+this.value/100),n.k("#my-range-value").text(i(t.uiConf.threshold())),t.vizs.attentionSvg.threshold(t.uiConf.threshold())}),100)),this.sels.headSelectAll.on("click",(function(){t.uiConf.selectAllHeads(),t._searchDisabler(),t.renderSvg(),t.renderAttHead()})),this.sels.headSelectNone.on("click",(function(){t.uiConf.selectNoHeads(),t._searchDisabler(),t.renderSvg(),t.renderAttHead(),D.setHidden(".atn-curve")}))}_initToggle(){Object(Ot.a)(this.sels.clsToggle.node(),"input").pipe(Object(Et.a)(t=>t.srcElement.checked)).subscribe({next:t=>{this.uiConf.hideClsSep(t),this.attCapsule.zeroed(t),this.renderSvg(),this.renderAttHead()}})}renderAttHead(){const t=a.range(0,this.uiConf.nHeads),e=this.attCapsule.att,s=W(e,t,"left"),i=W(e,t,"right");this.vizs.leftHeads.update(s),this.vizs.rightHeads.update(i),this._renderHeadSummary(),t.forEach(t=>{this.uiConf.headSet().has(t)?Lt(t):jt(t)})}renderTokens(){const t=this.tokCapsule[this.uiConf.attType[0]],e=this.tokCapsule[this.uiConf.attType[1]];this.vizs.tokens.left.update(t.tokenData),this.vizs.tokens.left.mask(t.maskInds),this.vizs.tokens.right.update(e.tokenData),this.vizs.tokens.right.mask(e.maskInds)}renderSvg(){const t=this.attCapsule.byHeads(this.uiConf.heads()),e=this.vizs.attentionSvg.data(t);e.update(t);const s=a.max([this.tokCapsule.a.length()]),i=e.options.boxheight*s;e.height(i),Rt(this.uiConf.token())}render(){this.renderTokens(),this.renderSvg(),this.renderAttHead()}update(){this.render()}}s(79),s(80),s(81);window.onload=()=>{new Nt,console.log("Done loading window")}}});